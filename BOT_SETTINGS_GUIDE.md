# Руководство по настройке уведомлений бота

## Обзор

Telegram бот Check поддерживает персональные настройки уведомлений для каждого пользователя. Каждый может установить своё время напоминаний и часовой пояс через команды бота.

## Команды для управления настройками

### Просмотр настроек

```
/settings
```

Показывает текущие настройки:
- Статус уведомлений (включены/выключены)
- Время отправки напоминаний
- Часовой пояс

### Включить/выключить уведомления

```
/remind on   - Включить уведомления
/remind off  - Отключить уведомления
```

Когда уведомления отключены, бот не будет отправлять ежедневные напоминания.

### Установить время напоминаний

```
/remind time HH:MM
```

**Примеры:**
```
/remind time 20:00  - Напоминания в 20:00
/remind time 21:30  - Напоминания в 21:30
/remind time 09:15  - Напоминания в 09:15
```

Формат: 24-часовой (00:00 - 23:59)

### Установить часовой пояс

```
/remind tz TIMEZONE
```

**Примеры:**
```
/remind tz Europe/Moscow      - Московское время (МСК)
/remind tz Europe/Kiev        - Киев
/remind tz Asia/Almaty        - Алматы
/remind tz America/New_York   - Нью-Йорк
/remind tz UTC                - Всемирное координированное время
```

**Полный список часовых поясов:**
https://en.wikipedia.org/wiki/List_of_tz_database_time_zones

## Как это работает

### Персональные настройки

1. При первом запуске `/start` для пользователя создаются настройки по умолчанию
2. По умолчанию используются значения из конфигурации сервера (`.env`)
3. Пользователь может изменить любые настройки через команды `/remind`
4. Настройки сохраняются в базе данных и применяются только к этому пользователю

### Отправка напоминаний

1. Бот проверяет каждую минуту (в UTC), каким пользователям нужно отправить напоминание
2. Для каждого пользователя:
   - Берётся его персональное время напоминаний
   - Берётся его персональный часовой пояс
   - Вычисляется, соответствует ли текущее UTC время настройкам пользователя
3. Напоминания отправляются только пользователям с включенными уведомлениями
4. Каждый пользователь получает напоминание в своё настроенное время

### Пример

**Пользователь 1:**
- Время: 20:00
- Часовой пояс: Europe/Moscow (UTC+3)
- Получит напоминание в 17:00 UTC

**Пользователь 2:**
- Время: 21:30
- Часовой пояс: Europe/Kiev (UTC+2)
- Получит напоминание в 19:30 UTC

**Пользователь 3:**
- Время: 09:00
- Часовой пояс: Asia/Tokyo (UTC+9)
- Получит напоминание в 00:00 UTC

Все пользователи получают напоминания в разное время UTC, но каждый в своё локальное время!

## Значения по умолчанию

Настройки по умолчанию задаются в файле `.env`:

```bash
# Время по умолчанию для новых пользователей
BOT_REMINDER_TIME=20:00

# Часовой пояс по умолчанию для новых пользователей
BOT_TIMEZONE=UTC

# Включить/выключить систему напоминаний глобально
BOT_REMINDERS_ENABLED=true
```

**Важно:** 
- `BOT_REMINDER_TIME` и `BOT_TIMEZONE` используются только как начальные значения для новых пользователей
- Каждый пользователь может изменить эти настройки для себя
- `BOT_REMINDERS_ENABLED=false` отключит напоминания для всех пользователей глобально

## Структура базы данных

Настройки хранятся в таблице `user_settings`:

```sql
CREATE TABLE user_settings (
    id INTEGER PRIMARY KEY,
    user_id INTEGER UNIQUE NOT NULL,
    reminders_enabled BOOLEAN DEFAULT TRUE,
    reminder_time VARCHAR(5),        -- Формат HH:MM
    timezone VARCHAR(50),             -- Название часового пояса
    FOREIGN KEY (user_id) REFERENCES user(id)
);
```

## Часто задаваемые вопросы

### Можно ли получать напоминания несколько раз в день?

В текущей версии поддерживается только одно напоминание в день на пользователя.

### Что если я путешествую и меняется часовой пояс?

Используйте команду `/remind tz` для обновления часового пояса. Напоминания будут приходить в установленное локальное время в новом часовом поясе.

### Могу ли я временно отключить напоминания?

Да, используйте `/remind off`. Для возобновления - `/remind on`.

### Как узнать, в какое время UTC я получу напоминание?

Бот автоматически конвертирует ваше локальное время в UTC. Вы можете проверить это онлайн-конвертером или просто дождаться первого напоминания.

### Что делать, если бот не отправляет напоминания?

1. Проверьте, что уведомления включены: `/settings`
2. Если выключены, включите: `/remind on`
3. Убедитесь, что время и часовой пояс установлены правильно
4. Проверьте, что вы не заблокировали бота в Telegram

## Разработка и отладка

### Проверка логов

Бот логирует информацию о отправке напоминаний:

```
INFO - Found 3 users for reminders at 17:00 UTC
INFO - Sent reminder to user 123456789 (time: 20:00, tz: Europe/Moscow)
```

### Тестирование

Для тестирования можно установить время напоминаний на ближайшую минуту:

```
/remind time 14:35
/remind tz UTC
```

Подождите до указанного времени UTC, и бот должен отправить напоминание.
